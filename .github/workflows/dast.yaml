name: ZAP DAST Scan

on:
  push:
    branches:
      - main

jobs:
  zap-dast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Start the app in background
        run: |
          python3 app.py &
          echo "Waiting for the app to start..."
          sleep 10

      - name: Create output folder for ZAP reports
        run: mkdir zap-output
      
      - name: Run ZAP scan
        run: |
          docker run --network host --rm --user 0 -v ${{ github.workspace }}/zap-output:/zap/wrk/output \
            -t ghcr.io/zaproxy/zaproxy:stable zap-full-scan.py \
            -t http://localhost:5000 \
            -J output/zap_report.json \

      - name: Sending Json to AccuKnox Console
        run: |
          curl --location --request POST "https://cspm.demo.accuknox.com/api/v1/artifact/?tenant_id=${{ secrets.AK_TENANT_ID }}&data_type=ZAP&label_id=DAST&save_to_s3=true" \
          --header "Tenant-Id: ${{ secrets.AK_TENANT_ID }}" \
          --header "Authorization: Bearer ${{ inputs.AK_TOKEN }}" \
          --form "file=@output/zap_report.json
